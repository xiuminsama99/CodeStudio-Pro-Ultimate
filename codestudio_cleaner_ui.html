<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeStudio Pro Ultimate - æ¸…ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            font-size: 1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .section-title {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .clean-level {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }

        .clean-level:hover {
            border-color: #4a90e2;
        }

        .clean-level.selected {
            border-color: #4a90e2;
            background: #f0f8ff;
        }

        .clean-level input[type="radio"] {
            margin-right: 10px;
        }

        .level-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .level-desc {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .level-details {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .action-area {
            text-align: center;
            margin: 25px 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin: 0 10px;
        }

        .btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-primary:hover {
            background: #357abd;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .result-content {
            font-family: 'Courier New', monospace;
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .progress {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: #4a90e2;
            width: 0%;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§¹ CodeStudio Pro æ¸…ç†å·¥å…·</h1>
            <p>é€‰æ‹©æ¸…ç†çº§åˆ«ï¼Œä¸€é”®å®Œæˆæ¸…ç†</p>
        </div>

        <div class="content">
            <!-- æ¸…ç†çº§åˆ«é€‰æ‹© -->
            <div class="section">
                <div class="section-title">é€‰æ‹©æ¸…ç†çº§åˆ«</div>

                <div class="clean-level" onclick="selectLevel('light')">
                    <input type="radio" name="clean-level" value="light" id="level-light" checked>
                    <label for="level-light">
                        <div class="level-title">ğŸ§  è½»åº¦æ¸…ç†ï¼ˆæ¨èï¼‰</div>
                        <div class="level-desc">åªæ¸…ç†ä½¿ç”¨é™åˆ¶ç›¸å…³çš„æ•°æ®ï¼Œä¿ç•™ä½ çš„è®¾ç½®å’Œé…ç½®</div>
                        <div class="level-details">æ¸…ç†å†…å®¹ï¼šä½¿ç”¨é™åˆ¶æ•°æ®ã€ä¸´æ—¶æ–‡ä»¶ã€è®¾å¤‡ID</div>
                    </label>
                </div>

                <div class="clean-level" onclick="selectLevel('deep')">
                    <input type="radio" name="clean-level" value="deep" id="level-deep">
                    <label for="level-deep">
                        <div class="level-title">ğŸ§¹ æ·±åº¦æ¸…ç†</div>
                        <div class="level-desc">æ¸…ç†æ›´å¤šæ•°æ®ï¼Œä½†ä¿ç•™é‡è¦çš„é…ç½®æ–‡ä»¶</div>
                        <div class="level-details">æ¸…ç†å†…å®¹ï¼šæ•°æ®åº“æ–‡ä»¶ã€ç¼“å­˜æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€è®¾å¤‡IDã€ç¯å¢ƒé…ç½®</div>
                    </label>
                </div>

                <div class="clean-level" onclick="selectLevel('complete')">
                    <input type="radio" name="clean-level" value="complete" id="level-complete">
                    <label for="level-complete">
                        <div class="level-title">ğŸ’¥ å®Œå…¨é‡ç½®</div>
                        <div class="level-desc">âš ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œå°±åƒé‡æ–°å®‰è£…ä¸€æ ·</div>
                        <div class="level-details">æ¸…ç†å†…å®¹ï¼šæ‰€æœ‰æ•°æ®åº“ã€æ‰€æœ‰é…ç½®æ–‡ä»¶ã€æ‰€æœ‰ç¼“å­˜ã€é‡æ–°è®¾ç½®ç¯å¢ƒ</div>
                    </label>
                </div>
            </div>

            <!-- æ‰§è¡Œæ“ä½œ -->
            <div class="action-area">
                <button class="btn btn-primary" onclick="startCleaning()" id="start-btn">
                    ğŸš€ å¼€å§‹æ¸…ç†
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    â† è¿”å›ä¸»é¡µ
                </button>
            </div>

            <!-- æ“ä½œç»“æœ -->
            <div class="section">
                <div class="section-title">æ“ä½œç»“æœ</div>

                <div class="progress hidden" id="progress">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>

                <div class="result-area">
                    <div class="result-title">æ‰§è¡Œæ—¥å¿—</div>
                    <div class="result-content" id="result-log">
å‡†å¤‡å°±ç»ªï¼Œè¯·é€‰æ‹©æ¸…ç†çº§åˆ«åç‚¹å‡»"å¼€å§‹æ¸…ç†"

ğŸ’¡ è¯´æ˜ï¼š
â€¢ è½»åº¦æ¸…ç†ï¼šé€‚åˆæ—¥å¸¸ä½¿ç”¨ï¼Œæ¸…ç†é™åˆ¶ä½†ä¿ç•™è®¾ç½®
â€¢ æ·±åº¦æ¸…ç†ï¼šè§£å†³å¤§éƒ¨åˆ†é—®é¢˜ï¼Œæ¸…ç†æ›´å½»åº•
â€¢ å®Œå…¨é‡ç½®ï¼šè§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†éœ€è¦é‡æ–°é…ç½®

â­ å»ºè®®é¦–æ¬¡ä½¿ç”¨é€‰æ‹©"è½»åº¦æ¸…ç†"
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLevel = 'light';
        let isOperating = false;

        // é€‰æ‹©æ¸…ç†çº§åˆ«
        function selectLevel(level) {
            if (isOperating) return;

            currentLevel = level;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.clean-level').forEach(el => {
                el.classList.remove('selected');
            });

            document.querySelector(`input[value="${level}"]`).checked = true;
            document.querySelector(`input[value="${level}"]`).closest('.clean-level').classList.add('selected');
        }

        // æ›´æ–°æ—¥å¿—
        function updateLog(message) {
            const log = document.getElementById('result-log');
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `\n[${timestamp}] ${message}`;
            log.scrollTop = log.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');

            if (percent > 0) {
                progress.classList.remove('hidden');
                progressBar.style.width = percent + '%';
            } else {
                progress.classList.add('hidden');
            }
        }

        // è®¾ç½®æ“ä½œçŠ¶æ€
        function setOperating(operating) {
            isOperating = operating;
            const startBtn = document.getElementById('start-btn');

            if (operating) {
                startBtn.disabled = true;
                startBtn.textContent = 'â³ æ¸…ç†ä¸­...';
            } else {
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸš€ å¼€å§‹æ¸…ç†';
            }
        }

        // å¼€å§‹æ¸…ç†
        async function startCleaning() {
            if (isOperating) return;

            const levelNames = {
                'light': 'è½»åº¦æ¸…ç†',
                'deep': 'æ·±åº¦æ¸…ç†',
                'complete': 'å®Œå…¨é‡ç½®'
            };

            const levelName = levelNames[currentLevel];

            if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ"${levelName}"å—ï¼Ÿ\n\nè¿™ä¸ªæ“ä½œå°†æ ¹æ®é€‰æ‹©çš„çº§åˆ«æ¸…ç†ç›¸åº”çš„æ•°æ®ã€‚`)) {
                return;
            }

            setOperating(true);
            updateLog(`å¼€å§‹æ‰§è¡Œ${levelName}...`);
            updateProgress(10);

            try {
                // æ ¹æ®çº§åˆ«è®¾ç½®æ¸…ç†é€‰é¡¹
                const options = getLevelOptions(currentLevel);

                updateProgress(30);
                updateLog('æ­£åœ¨æ¸…ç†æ•°æ®...');

                const response = await fetch('/api/clean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(options)
                });

                const result = await response.json();

                if (result.success) {
                    updateProgress(100);
                    updateLog('âœ… æ¸…ç†å®Œæˆï¼');
                    updateLog(`æˆåŠŸæ‰§è¡Œäº† ${result.completed_steps} ä¸ªæ¸…ç†æ­¥éª¤`);
                    updateLog('ğŸ‰ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨CodeStudio Proäº†');
                } else {
                    updateLog('âŒ æ¸…ç†å¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                updateLog('âŒ ç½‘ç»œè¿æ¥é”™è¯¯ï¼š' + error.message);
            }

            setOperating(false);
            setTimeout(() => updateProgress(0), 3000);
        }

        // æ ¹æ®çº§åˆ«è·å–æ¸…ç†é€‰é¡¹
        function getLevelOptions(level) {
            switch (level) {
                case 'light':
                    return {
                        smart_clean_database: true,
                        clean_system: true,
                        reset_ids: true
                    };
                case 'deep':
                    return {
                        clean_database: true,
                        clean_system: true,
                        reset_ids: true,
                        setup_environment: true
                    };
                case 'complete':
                    return {
                        complete_reset_database: true,
                        clean_system: true,
                        reset_ids: true,
                        setup_environment: true,
                        configure_app: true
                    };
                default:
                    return {
                        smart_clean_database: true,
                        clean_system: true,
                        reset_ids: true
                    };
            }
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            if (isOperating) {
                alert('æ¸…ç†æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¿”å›');
                return;
            }
            window.location.href = '/';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateLog('ğŸ§¹ æ¸…ç†å·¥å…·å·²å‡†å¤‡å°±ç»ª');
            updateLog('è¯·é€‰æ‹©åˆé€‚çš„æ¸…ç†çº§åˆ«ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ¸…ç†"');

            // é»˜è®¤é€‰æ‹©è½»åº¦æ¸…ç†
            selectLevel('light');
        });
    </script>
</body>
</html>
